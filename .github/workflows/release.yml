name: Release to Stable Repository

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Prepare build context
        run: |
          mkdir -p aquable/frontend
          cp -r frontend/dist aquable/frontend/
          cp -r src aquable/
          cp pyproject.toml aquable/

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push multi-arch images
        uses: home-assistant/builder@master
        with:
          args: |
            --target aquable \
            --docker-hub ghcr.io/${{ github.repository_owner }} \
            --all \
            --cache-from ghcr.io/${{ github.repository_owner }}/amd64-aquable:latest \
            --version ${{ steps.version.outputs.version }}

  sync-to-stable:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev repository
        uses: actions/checkout@v4
        with:
          path: dev

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build frontend
        run: |
          cd dev/frontend
          npm ci
          npm run build

      - name: Checkout stable repository
        uses: actions/checkout@v4
        with:
          repository: caleb-venner/AquaBle
          path: stable
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          ref: main
        continue-on-error: true

      - name: Initialize stable repository if needed
        run: |
          if [ ! -d "stable/.git" ]; then
            echo "Initializing new stable repository..."
            mkdir -p stable
            cd stable
            git init
            git config user.name 'github-actions[bot]'
            git config user.email 'github-actions[bot]@users.noreply.github.com'
            git remote add origin https://x-access-token:${{ secrets.PAT }}@github.com/caleb-venner/AquaBle.git
            git checkout -b main
          fi

      - name: Sync files to stable repository
        run: |
          # Selectively sync only the add-on files we maintain from dev
          # This preserves any stable-repo-specific files (docs, configs, etc.)
          
          # Copy add-on structure (remove old aquable/ dir first to clean stale files)
          rm -rf stable/aquable
          mkdir -p stable/aquable
          cp -r dev/aquable/* stable/aquable/
          
          # Copy built frontend to add-on directory
          mkdir -p stable/aquable/frontend
          cp -r dev/frontend/dist stable/aquable/frontend/
          
          # Copy source code to add-on directory (needed for Dockerfile build context)
          cp -r dev/src stable/aquable/
          
          # Copy root files that should be synced from dev
          cp dev/pyproject.toml stable/
          cp dev/LICENSE stable/
          
          # Copy README to root for GitHub display (overwrite is intentional)
          cp dev/aquable/README.stable.md stable/README.md
          
          # Create repository.yaml ONLY if it doesn't exist
          # This allows the stable repo to maintain its own repository.yaml
          if [ ! -f stable/repository.yaml ]; then
            cat > stable/repository.yaml << EOF
          name: AquaBle Add-on
          url: https://github.com/caleb-venner/AquaBle
          maintainer: Caleb Venner <caleb.venner@gmail.com>
          EOF
          fi

      - name: Commit and push to stable repository
        run: |
          cd stable
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "Release ${{ github.ref_name }}" || echo "No changes to commit"
          git push -u origin main || git push --force origin main
